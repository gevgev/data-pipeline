{
  "objects": [
    {
      "period": "1 Day",
      "name": "DefaultSchedule",
      "id": "DefaultSchedule",
      "myComment": "This object is used to specify the time-based trigger for executing Activities and for provisioning Resources of the pipeline. In this case it is used by the 'Default' object so it will cascade down to all other objects in the pipeline if they do not override it. For this example, we are using it to specify that our pipeline will run immediately upon activation. Also, we are using the 'occurrences' option specify that the pipeline should only be run once. You can have multiple schedules defined in a pipeline.",
      "type": "Schedule",
      "startAt": "FIRST_ACTIVATION_DATE_TIME"
    },
    {
      "imageId": "ami-35925e55",
      "instanceType": "c4.2xlarge",
      "name": "EC2ResourceObj",
      "id": "EC2ResourceObj",
      "type": "Ec2Resource",
      "myComment": "Ec-2 instance to run on",
      "terminateAfter": "18 Hour"
    },
    {
      "subject": "REPORTS SUCCESS: #{node.@scheduledStartTime}",
      "name": "SuccessNotify",
      "id": "SuccessNotify",
      "message": "Reports were generated from #{node.input} to #{node.output}.",
      "type": "SnsAlarm",
      "topicArn": "arn:aws:sns:us-west-2:539114338268:viewership-reports-completed"
    },
    {
      "output": {
        "ref": "S3OutputLocation"
      },
      "input": {
        "ref": "S3InputLocation"
      },
      "stage": "true",
      "onFail": {
        "ref": "ActionId_ZvAbc"
      },
      "name": "ShellCommandActivityObj",
      "id": "ShellCommandActivityObj",
      "runsOn": {
        "ref": "EC2ResourceObj"
      },
      "myComment": "Shell Command Activity Obj",
      "type": "ShellCommandActivity",
      "command": "#{myShellCmd}",
      "onSuccess": {
        "ref": "SuccessNotify"
      }
    },
    {
      "directoryPath": "#{myS3InputLoc}",
      "name": "S3InputLocation",
      "id": "S3InputLocation",
      "type": "S3DataNode",
      "myComment": "Input Stage S3 Location - binaries and scripts"
    },
    {
      "directoryPath": "#{myS3OutputLoc}/#{format(@scheduledStartTime, 'YYYY-MM-dd-HH-mm-ss')}",
      "name": "S3OutputLocation",
      "id": "S3OutputLocation",
      "type": "S3DataNode",
      "myComment": "Output S3 Location for Logs"
    },
    {
      "failureAndRerunMode": "CASCADE",
      "schedule": {
        "ref": "DefaultSchedule"
      },
      "resourceRole": "DataPipelineDefaultResourceRole",
      "role": "DataPipelineDefaultRole",
      "pipelineLogUri": "s3://daap-pipeline/",
      "scheduleType": "cron",
      "name": "Default",
      "id": "Default",
      "myComment": "Pipeline root object"
    },
    {
      "role": "DataPipelineDefaultRole",
      "subject": "FAILED Viewership reports",
      "name": "FailureNotify",
      "id": "ActionId_ZvAbc",
      "type": "SnsAlarm",
      "message": "Failed to generate viewership and household reports",
      "topicArn": "arn:aws:sns:us-west-2:539114338268:viewership-reports-completed"
    }
  ],
  "parameters": [
    {
      "description": "CDW AWS key",
      "id": "myCdwAwsKey",
      "type": "String"
    },
    {
      "description": "S3 input folder",
      "id": "myS3InputLoc",
      "type": "AWS::S3::ObjectKey"
    },
    {
      "description": "S3 output folder",
      "id": "myS3OutputLoc",
      "type": "AWS::S3::ObjectKey"
    },
    {
      "description": "Shell command to run",
      "id": "myShellCmd",
      "type": "String"
    },
    {
      "description": "CDW AWS secret",
      "id": "myCdwAwsSecret",
      "type": "String"
    }
  ],
  "values": {
    "myShellCmd": "cp ${INPUT1_STAGING_DIR}/* .\\nchmod u+x ./loop.sh\\nchmod u+x ./run.sh\\nchmod u+x ./aws-s3-uploader\\nchmod u+x ./cdwdatagetter\\nchmod u+x ./precondition\\n./loop.sh #{myCdwAwsKey} #{myCdwAwsSecret}",
    "myS3InputLoc": "s3://daap-pipeline/hh-viewership/",
    "myS3OutputLoc": "s3://daap-pipeline/",
  }
}